---
# Tasks para provisioning de software en Linux

- name: Actualizar cache de paquetes (apt)
  ansible.builtin.apt:
    update_cache: yes
    cache_valid_time: 3600
  when: ansible_pkg_mgr == 'apt'
  tags:
    - software
    - packages

- name: Actualizar cache de paquetes (yum/dnf)
  ansible.builtin.yum:
    update_cache: yes
  when: ansible_pkg_mgr in ['yum', 'dnf']
  tags:
    - software
    - packages

- name: Instalar paquetes básicos
  ansible.builtin.package:
    name: "{{ linux_packages }}"
    state: present
  tags:
    - software
    - packages

# NOTA: Tarea comentada porque Python 3.12+ protege paquetes del sistema (PEP 668)
# Si necesitas paquetes Python, instálalos con apt (ej: apt install python3-requests)
# - name: Instalar pip packages
#   ansible.builtin.pip:
#     name: "{{ item.name }}"
#     version: "{{ item.version | default(omit) }}"
#     state: "{{ item.state | default('present') }}"
#   loop: "{{ python_packages }}"
#   when: python_packages is defined
#   tags:
#     - software
#     - python

# Galaxy roles para servicios específicos
- name: Incluir rol de Docker
  ansible.builtin.include_role:
    name: geerlingguy.docker
  when: services_to_install.docker | default(false)
  tags:
    - software
    - docker

- name: Incluir rol de Nginx
  ansible.builtin.include_role:
    name: geerlingguy.nginx
  when: services_to_install.nginx | default(false)
  tags:
    - software
    - nginx

- name: Incluir rol de MySQL
  ansible.builtin.include_role:
    name: geerlingguy.mysql
  when: services_to_install.mysql | default(false)
  tags:
    - software
    - mysql

- name: Incluir rol de PostgreSQL
  ansible.builtin.include_role:
    name: geerlingguy.postgresql
  when: services_to_install.postgresql | default(false)
  tags:
    - software
    - postgresql

- name: Listar paquetes instalados
  ansible.builtin.package_facts:
    manager: auto
  tags:
    - software
    - info

- name: Verificar versiones de software clave
  ansible.builtin.command: "{{ item.command }}"
  loop:
    - { name: 'Python', command: 'python3 --version' }
    - { name: 'Git', command: 'git --version' }
  register: software_versions
  changed_when: false
  failed_when: false
  tags:
    - software
    - info

- name: Mostrar versiones de software
  ansible.builtin.debug:
    msg: "{{ item.item.name }}: {{ item.stdout }}"
  loop: "{{ software_versions.results }}"
  when: item.stdout is defined
  tags:
    - software
    - info
